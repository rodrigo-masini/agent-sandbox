name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  actions: read
  checks: write
  pull-requests: write

jobs:
  # PHP Backend Tests
  test-backend:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.0', '8.1', '8.2']
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: pdo, pdo_mysql, pdo_pgsql, redis, curl, json, opcache, mbstring, xml, zip, pcntl, posix
          coverage: xdebug
          tools: composer:v2, phpstan, phpcs, phpunit
          
      - name: Validate composer.json
        run: |
          cd backend
          composer validate --strict
          
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: backend/vendor
          key: ${{ runner.os }}-php-${{ matrix.php-version }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-${{ matrix.php-version }}-
          
      - name: Install dependencies
        run: |
          cd backend
          composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader
          
      - name: Run PHP linting
        run: |
          cd backend
          find src -name "*.php" -exec php -l {} \;
          
      - name: Run PHP CodeSniffer
        run: |
          cd backend
          vendor/bin/phpcs --standard=PSR12 src/ || true
          
      - name: Run PHPStan
        run: |
          cd backend
          vendor/bin/phpstan analyse --no-progress
          
      - name: Run Unit Tests with Coverage
        run: |
          cd backend
          vendor/bin/phpunit --coverage-clover=coverage.xml --coverage-text
          
      - name: Upload PHP Coverage
        uses: codecov/codecov-action@v3
        with:
          file: backend/coverage.xml
          flags: backend-php-${{ matrix.php-version }}
          
  # Python Frontend Tests
  test-frontend:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements/*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
          
      - name: Install dependencies
        run: |
          cd frontend
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements/dev.txt
          
      - name: Run linting
        run: |
          cd frontend
          flake8 src --max-line-length=120 --extend-ignore=E203,W503
          
      - name: Run type checking
        run: |
          cd frontend
          mypy src --ignore-missing-imports
          
      - name: Run Security Check with Bandit
        run: |
          cd frontend
          pip install bandit
          bandit -r src/ -f json -o bandit-report.json || true
          
      - name: Run Unit Tests with Coverage
        run: |
          cd frontend
          python -m pytest tests/ --cov=src --cov-report=term-missing --cov-report=xml -v
          
      - name: Upload Python Coverage
        uses: codecov/codecov-action@v3
        with:
          file: frontend/coverage.xml
          flags: frontend-python-${{ matrix.python-version }}

  # Integration Tests
  integration-tests:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    steps:
      - uses: actions/checkout@v4
      
      - name: Create .env file
        run: |
          cp .env.example .env
          sed -i 's/your_actual_api_key_here/test_api_key/g' .env
          sed -i 's/your_actual_org_id_here/test_org_id/g' .env
          sed -i 's/your_actual_project_id_here/test_project_id/g' .env
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build images
        run: |
          docker compose build --parallel
          
      - name: Start services
        run: |
          docker compose up -d
          echo "Waiting for services to be ready..."
          sleep 30
          
      - name: Check service health
        run: |
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8000/health && curl -f http://localhost:8080/api/health; then
              echo "Services are healthy"
              break
            fi
            echo "Attempt $((attempt + 1)) failed, retrying..."
            sleep 5
            attempt=$((attempt + 1))
          done
          
      - name: Run Backend Integration Tests
        run: |
          docker exec agtsdbx-backend-dev php vendor/bin/phpunit tests/Integration/
          
      - name: Run Frontend E2E Tests
        run: |
          docker exec agtsdbx-frontend-dev python -m pytest tests/test_e2e.py -v
          
      - name: Run Security Tests
        run: |
          docker exec agtsdbx-frontend-dev python -m pytest tests/security/ -v
          
      - name: Run Performance Tests
        run: |
          docker exec agtsdbx-frontend-dev python -m pytest tests/performance/ -v -m "not slow"
          
      - name: Test API Contract
        run: |
          # Test that frontend can communicate with backend
          docker exec agtsdbx-frontend-dev python -c "
import asyncio
from src.clients.agtsdbx_client import AgtsdbxClient

async def test():
    client = AgtsdbxClient('http://agtsdbx:8000')
    async with client:
        result = await client.health_check()
        assert result['status'] == 'healthy'
        print('API contract test passed')

asyncio.run(test())
"
          
      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose logs > docker-compose.log
          echo "=== Docker Compose Logs ===" && cat docker-compose.log
          
      - name: Clean up
        if: always()
        run: |
          docker compose down -v

  # Security Scanning
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy on Repository
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto
          
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'agent-sandbox'
          path: '.'
          format: 'HTML'
        continue-on-error: true

  # Load Testing
  load-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [integration-tests]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup K6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
          
      - name: Create load test script
        run: |
          cat > load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          
          export let options = {
            stages: [
              { duration: '30s', target: 20 },
              { duration: '1m', target: 20 },
              { duration: '30s', target: 0 },
            ],
            thresholds: {
              http_req_duration: ['p(95)<500'],
              http_req_failed: ['rate<0.1'],
            },
          };
          
          export default function() {
            let response = http.get('http://localhost:8000/health');
            check(response, {
              'status is 200': (r) => r.status === 200,
              'response time < 500ms': (r) => r.timings.duration < 500,
            });
            sleep(1);
          }
          EOF
          
      - name: Start services for load test
        run: |
          cp .env.example .env
          docker compose up -d
          sleep 30
          
      - name: Run load test
        run: |
          k6 run load-test.js --out json=load-test-results.json
          
      - name: Upload load test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: load-test-results.json
          
      - name: Clean up
        if: always()
        run: |
          docker compose down -v

  # All tests must pass
  tests-passed:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, integration-tests, security-scan]
    steps:
      - name: All tests passed
        run: echo "âœ… All tests passed successfully!"